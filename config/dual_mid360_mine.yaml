###############################################################################
# FAST-LIO Multi-Sensor Configuration
# Target: Dual Livox MID-360 for Underground Mine Navigation
# Hardware: NVIDIA Jetson ORIN + 2x MID-360
# ROS2: Humble/Iron
# Update Strategy: Adaptive (Bundle + Async switching)
###############################################################################

/**:
  ros__parameters:
    # ==========================================================================
    # MULTI-LIDAR CONFIGURATION
    # ==========================================================================
    multi_lidar: true                    # CRITICAL: Enable multi-LiDAR fusion mode

    update_mode: 2                       # 0=Bundle, 1=Async, 2=Adaptive

    # Adaptive mode thresholds
    adaptive_fov_threshold: 5000         # Switch to BUNDLE if total points in FOV < this value
                                         # Lower values = more aggressive async
                                         # Higher values = more conservative (more bundle)
                                         # 5000 is good for mine tunnels (sparse features)

    adaptive_feature_density: 0.002      # Min feature density (points/m³) to use ASYNC
                                         # If density falls below, switch to BUNDLE
                                         # Typical mine: 0.001-0.005

    adaptive_hysteresis_ratio: 1.2       # Hysteresis multiplier to prevent mode oscillation
                                         # Higher value = more stable but slower adaptation
                                         # Range: 1.1-1.5

    adaptive_stability_frames: 3         # Number of consecutive frames before mode switch
                                         # Prevents rapid oscillation between modes
                                         # Higher = more stable, lower = more responsive
                                         # Range: 2-10

    adaptive_debug_output: false         # Enable verbose logging of mode switches
                                         # Set to true for tuning and debugging
                                         # Warning: May reduce performance

    # ==========================================================================
    # FAST-LIO CORE PARAMETERS
    # ==========================================================================
    feature_extract_enable: false        # Use all points (no feature extraction)
                                         # MID-360 provides clean data, no need for extraction

    point_filter_num: 2                  # Downsampling: keep every Nth point
                                         # 2 = keep every 2nd point (50% reduction)
                                         # Lower value = more points = better for sparse mines
                                         # Livox recommended: 2-3

    max_iteration: 4                     # Max iterations for ICP optimization
                                         # Higher = more accurate but slower
                                         # 3-4 is good balance for real-time
                                         # Increase to 5 if accuracy critical

    filter_size_surf: 0.3                # Voxel size (m) for surface downsampling
                                         # Smaller = finer details, more computation
                                         # 0.3-0.5 good for mines (need detail for walls)

    filter_size_map: 0.4                 # Voxel size (m) for map downsampling
                                         # Smaller = denser map, more memory
                                         # 0.4-0.5 good balance

    cube_side_length: 200.0              # Local map cube size (meters)
                                         # Smaller = less memory, faster updates
                                         # 200m good for mines (not infinite like outdoor)

    runtime_pos_log_enable: false        # Log position during runtime (debugging)

    map_file_path: "/home/jetson/ros2_ws/src/fast_lio_ros2/PCD/mine_map.pcd"

    # ==========================================================================
    # COMMON SETTINGS
    # ==========================================================================
    common:
      # --- Topic Configuration ---
      # CRITICAL: These must match your livox_ros_driver2 output topics
      # Set multi_topic: 1 in livox_params.yaml to get separate topics
      lid_topic:  "/livox/lidar_192_168_1_10"   # Front MID-360 (IP: 192.168.1.10)
      lid_topic2: "/livox/lidar_192_168_1_18"   # Rear MID-360 (IP: 192.168.1.18)

      # IMU topic (shared from primary sensor or external IMU)
      imu_topic:  "/livox/imu_192_168_1_10"     # Primary MID-360 IMU

      # --- Time Synchronization ---
      time_sync_en: false                # Use hardware timestamps from sensors
                                         # Only enable if timestamps are unreliable
                                         # MID-360 has good built-in timestamps

      time_offset_lidar_to_imu: 0.0      # Time offset (seconds) between LiDAR and IMU
                                         # For MID-360 built-in IMU: typically 0.0
                                         # Calibrate with LI-Init if using external IMU

    # ==========================================================================
    # PREPROCESSING PARAMETERS
    # ==========================================================================
    preprocess:
      # --- PRIMARY LIDAR (LiDAR 1: Front-facing) ---
      lidar_type: 4                      # 1=AVIA, 2=Velodyne, 3=Ouster, 4=MID360, 5=Gazebo
      scan_line: 4                       # MID-360 has 4 scan lines
      blind: 0.3                         # Ignore points closer than 0.3m, Increase to 0.5m if heavy dust
      scan_rate: 10                      # LiDAR scan rate (Hz), MID-360 supports 10Hz
      timestamp_unit: 3                  # 0=sec, 1=ms, 2=μs, 3=ns, MID-360 uses nanoseconds
      point_filter_num: 2                # Downsample: keep 1 in every 2 points

      # --- SECONDARY LIDAR (LiDAR 2: Rear-facing) ---
      lidar_type2: 4                     # MID-360 (same as primary)
      scan_line2: 4
      blind2: 0.3                        # Match primary sensor
      scan_rate2: 10                     # Must match primary for synchronization
      timestamp_unit2: 3                 # Nanosecond timestamps
      point_filter_num2: 2               # Match primary downsampling

    # ==========================================================================
    # MAPPING & SENSOR FUSION PARAMETERS
    # ==========================================================================
    mapping:
      # --- IMU Noise Model ---
      # IMPORTANT: Underground mines have high vibration from rough terrain
      # Increase covariance values to handle vibration noise
      acc_cov: 0.5                       # Accelerometer noise covariance, Mine: 0.5-1.0 (higher vibration)
      gyr_cov: 0.5                       # Gyroscope noise covariance, Mine: 0.5-1.0 (higher vibration)
      b_acc_cov: 0.0001                  # Accelerometer bias covariance
      b_gyr_cov: 0.0001                  # Gyroscope bias covariance

      # --- Field of View & Detection Range ---
      fov_degree: 360.0                  # Total FOV with both sensors
      det_range: 50.0                    # Maximum detection range (meters)


      # --- Extrinsic Calibration ---
      # NOTE: Online estimation NOT supported for multi-LiDAR (yet)
      # Use offline calibration or manual measurement
      extrinsic_est_en: false            # Disable online extrinsic estimation

      # ======================================================================
      # REFERENCE FRAME: IMU BODY FRAME (LiDAR 1 Built-in IMU)
      # ======================================================================
      # Following FAST_LIO_MULTI convention:
      # - Primary reference frame is the IMU body frame (L1's built-in IMU)
      # - Using built-in IMU from LiDAR 1 (IP: 192.168.1.10)
      # - UPDATED: L1 optical center has ~50mm offset from IMU (per Mid-360 docs)
      # - All extrinsics express sensor pose relative to L1's IMU frame
      # - This provides more accurate calibration than assuming co-location
      # ======================================================================

      # ======================================================================
      # LIDAR 1 EXTRINSICS (Primary LiDAR → IMU Body Frame)
      # ======================================================================
      # IP: 192.168.1.10 (Left Sensor - Built-in IMU is the reference)
      #
      # UPDATED: Using Mid-360 documentation values for LiDAR-to-IMU offset
      # The LiDAR optical center and IMU are NOT perfectly co-located.
      # There is a small offset between them as per Mid-360 datasheet.
      #
      # Translation: Offset from LiDAR optical center to IMU in LiDAR body frame
      # Rotation: IDENTITY (LiDAR and IMU share the same orientation)
      # ======================================================================
      extrinsic_T: [-0.011, -0.02329, 0.04412]  # [x, y, z] meters - Mid-360 documentation
      #   x = -0.011m:   11mm offset along X-axis
      #   y = -0.02329m: 23.29mm offset along Y-axis
      #   z =  0.04412m: 44.12mm offset along Z-axis

      # Rotation matrix: IDENTITY (LiDAR 1 and IMU share same orientation)
      extrinsic_R: [ 1.00,  0.00,  0.00,
                     0.00,  1.00,  0.00,
                     0.00,  0.00,  1.00]

      # ======================================================================
      # LIDAR 2 EXTRINSICS (Secondary LiDAR → IMU Body Frame)
      # ======================================================================
      # IP: 192.168.1.18 (Right Sensor)
      #
      # Physical Configuration (from Livox driver config):
      # - LiDAR 1: [0, 110, 0] mm relative to base_link, Roll=90°, Yaw=180° (backward)
      # - LiDAR 2: [0, -110, 0] mm relative to base_link, Roll=90°, Yaw=0° (forward)
      # - Base separation: 220mm lateral
      #
      # Computation accounting for L1 IMU offset:
      # - L1 IMU position in base_link = L1_optical + R1 * [-0.011, -0.02329, 0.04412]
      #                                = [0, 0.11, 0] + [0.011, 0.04412, -0.02329]
      #                                = [0.011, 0.15412, -0.02329] meters
      # - L2 optical center in base_link = [0, -0.11, 0] meters
      # - L2 relative to L1 IMU in base_link = [0, -0.11, 0] - [0.011, 0.15412, -0.02329]
      #                                      = [-0.011, -0.26412, 0.02329] meters
      # - Rotate into L1 IMU frame using R1^T:
      #   T_L2_in_L1_IMU = R1^T * [-0.011, -0.26412, 0.02329] = [0.011, 0.02329, -0.26412]
      # ======================================================================
      
      extrinsic_T_L2_wrt_L1: [0.011, 0.02329, -0.26412]  # Same as extrinsic_T2

      # Relative rotation: 180° yaw (sensors facing opposite directions)
      extrinsic_R_L2_wrt_L1: [-1.00000,  0.00000,  0.00000,
                               0.00000, -1.00000,  0.00000,
                               0.00000,  0.00000,  1.00000]

    # ==========================================================================
    # PUBLISHING OPTIONS
    # ==========================================================================
    publish:
      path_en: true                      # Publish odometry path (/path topic)
      effect_map_en: false               # Publish effective map points, Disable to reduce computational load
      map_en: true                       # Publish global map (/cloud_registered), map visualization
      scan_publish_en: true              # Publish current scan (/cloud_registered_body)
      dense_publish_en: false            # Publish dense point cloud
      scan_bodyframe_pub_en: true        # Publish scan in body frame, Helps verify extrinsic calibration

    # ==========================================================================
    # PCD MAP SAVING
    # ==========================================================================
    pcd_save:
      pcd_save_en: true                  # Save final map to PCD file
      pcd_file_name: "mine_dual_mid360.pcd"  # Output filename
      interval: -1                       # Save interval (# of LiDAR frames)
                                         # -1: Save all frames at end (single file)
                                         # >0: Save every N frames (multiple files)
                                         # For mines: -1 recommended (single complete map)

###############################################################################
# CALIBRATION INSTRUCTIONS - IMU BODY FRAME REFERENCE
###############################################################################
#
# FAST_LIO_MULTI uses the IMU BODY FRAME as the primary reference.
# This configuration uses LiDAR 1's built-in IMU as the reference frame.
#
# UPDATED: Now using precise Mid-360 documentation values for LiDAR-IMU offset
#
# 1. IDENTIFY YOUR IMU REFERENCE:
#    - Built-in IMU from one of the LiDARs (most common for MID-360)
#    - External IMU (separate sensor)
#    - This config uses: LiDAR 1 (192.168.1.10) built-in IMU
#
# 2. PRIMARY LIDAR (with IMU) EXTRINSICS:
#    - For Mid-360: Use datasheet values for LiDAR-to-IMU offset
#    - extrinsic_T = [-0.011, -0.02329, 0.04412] (from Mid-360 documentation)
#    - extrinsic_R = Identity (LiDAR and IMU share same orientation)
#    - This accounts for the ~50mm offset between optical center and IMU
#
# 3. SECONDARY LIDAR EXTRINSICS:
#    - Must account for BOTH:
#      a) Physical separation between LiDAR sensors (from Livox config)
#      b) L1 LiDAR-to-IMU offset (so L2 is relative to L1's IMU, not L1's optical center)
#    - Computation method:
#      1. Find L1 IMU position: P_L1_IMU = P_L1_optical + R_L1 * T_lidar_to_IMU
#      2. Find L2 relative position: P_L2_rel = P_L2_optical - P_L1_IMU
#      3. Rotate into L1 IMU frame: T_L2_in_IMU = R_L1^T * P_L2_rel
#
# 4. COMPUTING FROM BASE_LINK EXTRINSICS:
#    If you have Livox driver extrinsics relative to base_link:
#    Step 1: Compute L1 IMU position in base_link frame
#            P_L1_IMU_base = P_L1_base + R_L1_base * [-0.011, -0.02329, 0.04412]
#    Step 2: Compute L2 position relative to L1 IMU in base_link frame
#            P_L2_rel_base = P_L2_base - P_L1_IMU_base
#    Step 3: Rotate into L1 IMU frame
#            extrinsic_T2 = R_L1_base^T * P_L2_rel_base
#    Step 4: Compute relative rotation
#            extrinsic_R2 = R_L1_base^T * R_L2_base
#
# 5. OFFLINE CALIBRATION (Advanced):
#    - Collect rosbag with both sensors in static environment
#    - Use GICP-based calibration (LI-Init, TIERS tools)
#    - Extract sensor-to-sensor transformation
#    - Update extrinsic_T2 and extrinsic_R2 parameters
#
# 6. VALIDATION:
#    - Visualize both sensor clouds in RViz2 fixed frame: map
#    - Check alignment at sensor overlap regions
#    - Verify no ghosting, double walls, or misalignment
#    - Static scene test: walls should be thin (10-20cm), not thick (50cm+)
#    - Moving test: Verify map consistency during motion
#
###############################################################################

###############################################################################
# TUNING GUIDE FOR UNDERGROUND MINES
###############################################################################
#
# FEATURE-SPARSE TUNNELS:
#   - Increase point_filter_num: 2 → 1 (keep more points)
#   - Decrease filter_size_surf: 0.3 → 0.2 (finer detail)
#   - Increase adaptive_fov_threshold: 5000 → 8000 (more bundle mode)
#
# HIGH VIBRATION:
#   - Increase acc_cov: 0.5 → 1.0
#   - Increase gyr_cov: 0.5 → 1.0
#   - Increase max_iteration: 4 → 5
#
# DUSTY CONDITIONS:
#   - Increase blind: 0.3 → 0.5 (ignore dust near sensor)
#   - Reduce det_range: 50 → 30 (dust limits visibility)
#   - Monitor point cloud quality metrics
#
# FAST MOTION:
#   - Set update_mode: 1 (pure async for low latency)
#   - Increase scan_rate: 10 → 20 (if sensors support)
#   - Reduce max_iteration: 4 → 3 (faster convergence)
#
# COMPUTATIONAL LIMITS (Jetson ORIN Nano):
#   - Increase point_filter_num: 2 → 3 (more downsampling)
#   - Increase filter_size_surf: 0.3 → 0.5
#   - Disable dense_publish_en: false
#   - Reduce cube_side_length: 200 → 100
#
###############################################################################