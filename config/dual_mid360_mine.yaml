###############################################################################
# FAST-LIO Multi-Sensor Configuration
# Target: Dual Livox MID-360 for Underground Mine Navigation
# Hardware: NVIDIA Jetson ORIN + 2x MID-360
# ROS2: Humble/Iron
# Update Strategy: Adaptive (Bundle + Async switching)
###############################################################################

/**:
  ros__parameters:
    # ==========================================================================
    # MULTI-LIDAR CONFIGURATION
    # ==========================================================================
    multi_lidar: true                    # CRITICAL: Enable multi-LiDAR fusion mode
                                         # When true, system subscribes to multiple LiDAR topics
                                         # and fuses data using adaptive strategy

    # ==========================================================================
    # ADAPTIVE UPDATE STRATEGY PARAMETERS
    # ==========================================================================
    # Three update modes:
    #   0 = BUNDLE:   Merge both LiDAR scans, then update filter once
    #                 Pros: Max features per update, robust in sparse areas
    #                 Cons: Lower update rate (10Hz), higher latency
    #
    #   1 = ASYNC:    Update filter separately for each LiDAR scan
    #                 Pros: Higher update rate (20Hz), lower drift
    #                 Cons: Risk of insufficient FOV per update
    #
    #   2 = ADAPTIVE: Dynamically switch between BUNDLE and ASYNC based on
    #                 feature density and environment characteristics
    #                 Pros: Best of both approaches, environment-aware
    #                 Cons: Slightly higher computational complexity
    # ==========================================================================
    update_mode: 2                       # 0=Bundle, 1=Async, 2=Adaptive

    # Adaptive mode thresholds
    adaptive_fov_threshold: 5000         # Switch to BUNDLE if total points in FOV < this value
                                         # Lower values = more aggressive async
                                         # Higher values = more conservative (more bundle)
                                         # 5000 is good for mine tunnels (sparse features)

    adaptive_feature_density: 0.002      # Min feature density (points/m³) to use ASYNC
                                         # If density falls below, switch to BUNDLE
                                         # Typical mine: 0.001-0.005

    adaptive_hysteresis_ratio: 1.2       # Hysteresis multiplier to prevent mode oscillation
                                         # Higher value = more stable but slower adaptation
                                         # Range: 1.1-1.5

    adaptive_stability_frames: 3         # Number of consecutive frames before mode switch
                                         # Prevents rapid oscillation between modes
                                         # Higher = more stable, lower = more responsive
                                         # Range: 2-10

    adaptive_debug_output: false         # Enable verbose logging of mode switches
                                         # Set to true for tuning and debugging
                                         # Warning: May reduce performance

    # ==========================================================================
    # FAST-LIO CORE PARAMETERS
    # ==========================================================================
    feature_extract_enable: false        # Use all points (no feature extraction)
                                         # MID-360 provides clean data, no need for extraction

    point_filter_num: 2                  # Downsampling: keep every Nth point
                                         # 2 = keep every 2nd point (50% reduction)
                                         # Lower value = more points = better for sparse mines
                                         # Livox recommended: 2-3

    max_iteration: 4                     # Max iterations for ICP optimization
                                         # Higher = more accurate but slower
                                         # 3-4 is good balance for real-time
                                         # Increase to 5 if accuracy critical

    filter_size_surf: 0.3                # Voxel size (m) for surface downsampling
                                         # Smaller = finer details, more computation
                                         # 0.3-0.5 good for mines (need detail for walls)

    filter_size_map: 0.4                 # Voxel size (m) for map downsampling
                                         # Smaller = denser map, more memory
                                         # 0.4-0.5 good balance

    cube_side_length: 200.0              # Local map cube size (meters)
                                         # Smaller = less memory, faster updates
                                         # 200m good for mines (not infinite like outdoor)

    runtime_pos_log_enable: false        # Log position during runtime (debugging)

    map_file_path: "/home/jetson/ros2_ws/src/fast_lio_ros2/PCD/mine_map.pcd"

    # ==========================================================================
    # COMMON SETTINGS
    # ==========================================================================
    common:
      # --- Topic Configuration ---
      # CRITICAL: These must match your livox_ros_driver2 output topics
      # Set multi_topic: 1 in livox_params.yaml to get separate topics
      lid_topic:  "/livox/lidar_192_168_1_10"   # Front MID-360 (IP: 192.168.1.10)
      lid_topic2: "/livox/lidar_192_168_1_18"   # Rear MID-360 (IP: 192.168.1.18)

      # IMU topic (shared from primary sensor or external IMU)
      imu_topic:  "/livox/imu_192_168_1_10"     # Primary MID-360 IMU

      # --- Time Synchronization ---
      time_sync_en: false                # Use hardware timestamps from sensors
                                         # Only enable if timestamps are unreliable
                                         # MID-360 has good built-in timestamps

      time_offset_lidar_to_imu: 0.0      # Time offset (seconds) between LiDAR and IMU
                                         # For MID-360 built-in IMU: typically 0.0
                                         # Calibrate with LI-Init if using external IMU

    # ==========================================================================
    # PREPROCESSING PARAMETERS
    # ==========================================================================
    preprocess:
      # --- PRIMARY LIDAR (LiDAR 1: Front-facing) ---
      lidar_type: 4                      # 1=AVIA, 2=Velodyne, 3=Ouster, 4=MID360, 5=Gazebo
      scan_line: 4                       # MID-360 has 4 scan lines
      blind: 0.3                         # Ignore points closer than 0.3m
                                         # Prevents ground clutter and dust near sensor
                                         # Increase to 0.5m if heavy dust
      scan_rate: 10                      # LiDAR scan rate (Hz)
                                         # MID-360 supports 10Hz (standard)
      timestamp_unit: 3                  # 0=sec, 1=ms, 2=μs, 3=ns
                                         # MID-360 uses nanoseconds
      point_filter_num: 2                # Downsample: keep 1 in every 2 points

      # --- SECONDARY LIDAR (LiDAR 2: Rear-facing) ---
      lidar_type2: 4                     # MID-360 (same as primary)
      scan_line2: 4
      blind2: 0.3                        # Match primary sensor
      scan_rate2: 10                     # Must match primary for synchronization
      timestamp_unit2: 3                 # Nanosecond timestamps
      point_filter_num2: 2               # Match primary downsampling

    # ==========================================================================
    # MAPPING & SENSOR FUSION PARAMETERS
    # ==========================================================================
    mapping:
      # --- IMU Noise Model ---
      # IMPORTANT: Underground mines have high vibration from rough terrain
      # Increase covariance values to handle vibration noise
      acc_cov: 0.5                       # Accelerometer noise covariance
                                         # Default: 0.1, Mine: 0.5-1.0 (higher vibration)
      gyr_cov: 0.5                       # Gyroscope noise covariance
                                         # Default: 0.1, Mine: 0.5-1.0 (higher vibration)
      b_acc_cov: 0.0001                  # Accelerometer bias covariance
      b_gyr_cov: 0.0001                  # Gyroscope bias covariance

      # --- Field of View & Detection Range ---
      fov_degree: 360.0                  # Total FOV with both sensors
                                         # Front (120°) + Rear (120°) ≈ 360° coverage
      det_range: 50.0                    # Maximum detection range (meters)
                                         # Typical mine visibility: 30-50m
                                         # Reduce if dust limits effective range

      # --- Extrinsic Calibration ---
      # NOTE: Online estimation NOT supported for multi-LiDAR (yet)
      # Use offline calibration or manual measurement
      extrinsic_est_en: false            # Disable online extrinsic estimation

      # ======================================================================
      # REFERENCE FRAME: IMU BODY FRAME (LiDAR 1 Built-in IMU)
      # ======================================================================
      # Following FAST_LIO_MULTI convention:
      # - Primary reference frame is the IMU body frame
      # - Using built-in IMU from LiDAR 1 (IP: 192.168.1.10)
      # - IMU frame coincides with LiDAR 1 optical center
      # - All extrinsics express sensor pose relative to this IMU frame
      # ======================================================================

      # ======================================================================
      # LIDAR 1 EXTRINSICS (Primary LiDAR → IMU Body Frame)
      # ======================================================================
      # IP: 192.168.1.10 (Left Sensor - Built-in IMU is the reference)
      #
      # IMPORTANT: Since we're using LiDAR 1's built-in IMU as reference,
      # LiDAR 1 and IMU are CO-LOCATED at the same position and orientation.
      #
      # Translation: IDENTITY (no offset, they're at the same location)
      # Rotation: IDENTITY (no rotation, they share the same frame)
      # ======================================================================
      extrinsic_T: [0.0, 0.0, 0.0]       # [x, y, z] meters - IDENTITY transform
      #   LiDAR 1 optical center = IMU center (co-located)

      # Rotation matrix: IDENTITY (LiDAR 1 frame = IMU frame)
      extrinsic_R: [ 1.00000,  0.00000,  0.00000,
                     0.00000,  1.00000,  0.00000,
                     0.00000,  0.00000,  1.00000]

      # ======================================================================
      # LIDAR 2 EXTRINSICS (Secondary LiDAR → IMU Body Frame)
      # ======================================================================
      # IP: 192.168.1.18 (Right Sensor)
      #
      # Physical Configuration (from Livox driver config):
      # - LiDAR 1: 11cm left of base_link (+Y), facing backward (Yaw=180°)
      # - LiDAR 2: 11cm right of base_link (-Y), facing forward (Yaw=0°)
      # - Base separation: 22cm lateral
      #
      # Since IMU frame = LiDAR 1 frame:
      # - LiDAR 1 is at [0, +0.11, 0] relative to base_link, Yaw=180°
      # - LiDAR 2 is at [0, -0.11, 0] relative to base_link, Yaw=0°
      #
      # Transform LiDAR 2 → IMU (LiDAR 1):
      # Translation: T_L2_to_IMU = T_L2_to_base - T_L1_to_base
      #            = [0, -0.11, 0] - [0, +0.11, 0] = [0, -0.22, 0]
      # Rotation: L2 faces forward (0°), L1 faces backward (180°)
      #           Relative rotation = 180° yaw difference
      # ======================================================================
      extrinsic_T2: [0.0, -0.22, 0.0]    # [x, y, z] meters
      #   x =  0.00m: Same longitudinal position as LiDAR 1
      #   y = -0.22m: 22cm to the RIGHT of LiDAR 1 (lateral baseline)
      #   z =  0.00m: Same height as LiDAR 1

      # Rotation: LiDAR 2 faces opposite direction to LiDAR 1
      # LiDAR 1 (IMU): Yaw=180° (backward), Roll=90°
      # LiDAR 2:       Yaw=0° (forward), Roll=90°
      # Relative rotation: 180° yaw rotation
      # R_L2_to_IMU = R_L2_to_base * R_base_to_L1 = R_L2_to_base * R_L1_to_base^T
      #
      # From Livox config:
      #   R_L1 (Roll=90°, Yaw=180°) = [-1, 0, 0; 0, 0, 1; 0, 1, 0]
      #   R_L2 (Roll=90°, Yaw=0°)   = [ 1, 0, 0; 0, 0,-1; 0, 1, 0]
      # Relative: R_L2_to_L1 = R_L2 * R_L1^T = [-1, 0, 0; 0,-1, 0; 0, 0, 1]
      extrinsic_R2: [-1.00000,  0.00000,  0.00000,
                      0.00000, -1.00000,  0.00000,
                      0.00000,  0.00000,  1.00000]

      # ======================================================================
      # RELATIVE TRANSFORM: LiDAR 2 w.r.t. LiDAR 1 (IMU Frame)
      # ======================================================================
      # Following FAST_LIO_MULTI convention: providing relative transform as
      # a convenience parameter for internal fusion algorithms.
      #
      # Since LiDAR 1 = IMU reference frame:
      # - extrinsic_T_L2_wrt_L1 = extrinsic_T2 (they're the same)
      # - extrinsic_R_L2_wrt_L1 = extrinsic_R2 (they're the same)
      #
      # Translation: LiDAR 2 is 22cm to the right of LiDAR 1/IMU
      # Rotation: LiDAR 2 faces opposite direction (180° yaw relative rotation)
      # ======================================================================
      extrinsic_T_L2_wrt_L1: [0.0, -0.22, 0.0]  # Same as extrinsic_T2

      # Relative rotation: 180° yaw (sensors facing opposite directions)
      extrinsic_R_L2_wrt_L1: [-1.00000,  0.00000,  0.00000,
                               0.00000, -1.00000,  0.00000,
                               0.00000,  0.00000,  1.00000]

    # ==========================================================================
    # PUBLISHING OPTIONS
    # ==========================================================================
    publish:
      path_en: true                      # Publish odometry path (/path topic)
                                         # Essential for visualization and monitoring

      effect_map_en: false               # Publish effective map points
                                         # Disable to reduce computational load

      map_en: true                       # Publish global map (/cloud_registered)
                                         # Important for map visualization

      scan_publish_en: true              # Publish current scan (/cloud_registered_body)
                                         # Useful for debugging sensor alignment

      dense_publish_en: false            # Publish dense point cloud
                                         # Disable to save bandwidth/CPU

      scan_bodyframe_pub_en: true        # Publish scan in body frame
                                         # Helps verify extrinsic calibration

    # ==========================================================================
    # PCD MAP SAVING
    # ==========================================================================
    pcd_save:
      pcd_save_en: true                  # Save final map to PCD file
                                         # Important for mine surveying/mapping

      pcd_file_name: "mine_dual_mid360.pcd"  # Output filename

      interval: -1                       # Save interval (# of LiDAR frames)
                                         # -1: Save all frames at end (single file)
                                         # >0: Save every N frames (multiple files)
                                         # For mines: -1 recommended (single complete map)

###############################################################################
# CALIBRATION INSTRUCTIONS - IMU BODY FRAME REFERENCE
###############################################################################
#
# FAST_LIO_MULTI uses the IMU BODY FRAME as the primary reference.
# This configuration uses LiDAR 1's built-in IMU as the reference frame.
#
# 1. IDENTIFY YOUR IMU REFERENCE:
#    - Built-in IMU from one of the LiDARs (most common for MID-360)
#    - External IMU (separate sensor)
#    - This config assumes: LiDAR 1 (192.168.1.10) built-in IMU
#
# 2. PRIMARY LIDAR (with IMU) EXTRINSICS:
#    - If using built-in IMU: extrinsic_T = [0,0,0], extrinsic_R = Identity
#    - The LiDAR optical center coincides with the IMU center
#    - No transformation needed
#
# 3. SECONDARY LIDAR EXTRINSICS:
#    - Measure position RELATIVE TO PRIMARY LIDAR (not base_link!)
#    - Translation: [dx, dy, dz] from LiDAR 1 center to LiDAR 2 center
#    - Rotation: Orientation difference between the two sensors
#    - Use physical measurements or CAD model
#
# 4. COMPUTING FROM BASE_LINK EXTRINSICS:
#    If you have extrinsics relative to base_link:
#    - T_L2_to_IMU = T_L2_to_base - T_L1_to_base
#    - R_L2_to_IMU = R_L2_to_base * R_L1_to_base^T (matrix multiplication)
#
# 5. OFFLINE CALIBRATION (Advanced):
#    - Collect rosbag with both sensors in static environment
#    - Use GICP-based calibration (LI-Init, TIERS tools)
#    - Extract sensor-to-sensor transformation
#    - Update extrinsic_T2 and extrinsic_R2 parameters
#
# 6. VALIDATION:
#    - Visualize both sensor clouds in RViz2
#    - Check alignment at sensor overlap regions
#    - Verify no ghosting, double walls, or misalignment
#    - Static scene test: walls should be thin (10-20cm), not thick (50cm+)
#
###############################################################################

###############################################################################
# TUNING GUIDE FOR UNDERGROUND MINES
###############################################################################
#
# FEATURE-SPARSE TUNNELS:
#   - Increase point_filter_num: 2 → 1 (keep more points)
#   - Decrease filter_size_surf: 0.3 → 0.2 (finer detail)
#   - Increase adaptive_fov_threshold: 5000 → 8000 (more bundle mode)
#
# HIGH VIBRATION:
#   - Increase acc_cov: 0.5 → 1.0
#   - Increase gyr_cov: 0.5 → 1.0
#   - Increase max_iteration: 4 → 5
#
# DUSTY CONDITIONS:
#   - Increase blind: 0.3 → 0.5 (ignore dust near sensor)
#   - Reduce det_range: 50 → 30 (dust limits visibility)
#   - Monitor point cloud quality metrics
#
# FAST MOTION:
#   - Set update_mode: 1 (pure async for low latency)
#   - Increase scan_rate: 10 → 20 (if sensors support)
#   - Reduce max_iteration: 4 → 3 (faster convergence)
#
# COMPUTATIONAL LIMITS (Jetson ORIN Nano):
#   - Increase point_filter_num: 2 → 3 (more downsampling)
#   - Increase filter_size_surf: 0.3 → 0.5
#   - Disable dense_publish_en: false
#   - Reduce cube_side_length: 200 → 100
#
###############################################################################
