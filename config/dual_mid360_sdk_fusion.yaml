###############################################################################
# FAST-LIO SDK Fusion Configuration
# Target: Dual Livox MID-360 with SDK-level Fusion for Underground Mine Navigation
# Hardware: NVIDIA Jetson ORIN + 2x MID-360
# ROS2: Humble/Iron
# Fusion Mode: Livox SDK (single fused point cloud + single IMU)
###############################################################################
#
# IMPORTANT: This configuration assumes:
# 1. livox_ros_driver2 is configured with multi_topic: 0 (SDK fusion enabled)
# 2. The driver uses multiple_netconfigs.json with extrinsics relative to base_link
# 3. The driver publishes fused point cloud to /livox/lidar
# 4. The driver publishes IMU data to /livox/imu (from primary LiDAR 192.168.1.10)
#
###############################################################################

/**:
  ros__parameters:
    # ==========================================================================
    # FAST-LIO CORE PARAMETERS
    # ==========================================================================
    feature_extract_enable: false        # Use all points (no feature extraction)
                                         # MID-360 provides clean data, SDK fusion already processed

    point_filter_num: 2                  # Downsampling: keep every Nth point
                                         # 2 = 50% reduction (good balance for fused cloud)
                                         # Adjust based on Jetson performance

    max_iteration: 4                     # Max iterations for ICP optimization
                                         # 3-4 is good balance for real-time performance

    filter_size_surf: 0.3                # Voxel size (m) for surface downsampling
                                         # 0.3-0.5 good for mines (need wall detail)

    filter_size_map: 0.4                 # Voxel size (m) for map downsampling
                                         # 0.4-0.5 good balance for memory usage

    cube_side_length: 200.0              # Local map cube size (meters)
                                         # 200m good for mines (not infinite like outdoor)

    runtime_pos_log_enable: false        # Log position during runtime (debugging)

    map_file_path: "/home/jetson/ros2_ws/src/fast_lio_ros2/PCD/mine_sdk_fusion.pcd"

    # ==========================================================================
    # COMMON SETTINGS - SDK FUSION MODE
    # ==========================================================================
    common:
      # --- Topic Configuration ---
      # SDK fusion mode: Single fused topic from livox_ros_driver2
      lid_topic:  "/livox/lidar"         # Fused point cloud from both MID-360 sensors
      imu_topic:  "/livox/imu"           # IMU from primary sensor (192.168.1.10)

      # --- Time Synchronization ---
      time_sync_en: false                # Use hardware timestamps from sensors
                                         # MID-360 has good built-in timestamps

      time_offset_lidar_to_imu: 0.0      # Time offset (seconds) between LiDAR and IMU
                                         # For MID-360 built-in IMU: typically 0.0

    # ==========================================================================
    # PREPROCESSING PARAMETERS
    # ==========================================================================
    preprocess:
      lidar_type: 4                      # 4 = MID360 LiDAR
      scan_line: 4                       # MID-360 has 4 scan lines
      blind: 0.3                         # Ignore points closer than 0.3m
                                         # Increase to 0.5m if heavy dust
      scan_rate: 10                      # LiDAR scan rate (Hz)
      timestamp_unit: 3                  # 3 = nanoseconds (MID-360 default)
      point_filter_num: 2                # Downsample: keep 1 in every 2 points

    # ==========================================================================
    # MAPPING & SENSOR FUSION PARAMETERS
    # ==========================================================================
    mapping:
      # --- IMU Noise Model ---
      # Underground mines have high vibration from rough terrain
      acc_cov: 0.5                       # Accelerometer noise covariance
                                         # Mine: 0.5-1.0 (higher vibration tolerance)
      gyr_cov: 0.5                       # Gyroscope noise covariance
                                         # Mine: 0.5-1.0 (higher vibration tolerance)
      b_acc_cov: 0.0001                  # Accelerometer bias covariance
      b_gyr_cov: 0.0001                  # Gyroscope bias covariance

      # --- Field of View & Detection Range ---
      fov_degree: 360.0                  # Total FOV with SDK-fused dual sensors
      det_range: 50.0                    # Maximum detection range (meters)
                                         # Adjust based on dust conditions

      # --- Extrinsic Calibration ---
      extrinsic_est_en: false            # Disable online estimation
                                         # Use calibrated values from Livox SDK config

      # ======================================================================
      # EXTRINSICS: LiDAR to IMU Transformation
      # ======================================================================
      # Reference Frame: IMU from primary LiDAR (192.168.1.10)
      #
      # IMPORTANT: The Livox SDK applies the extrinsics from multiple_netconfigs.json
      # to transform both LiDAR point clouds to base_link before fusion.
      # The fused cloud published to /livox/lidar is in base_link frame.
      #
      # Since FAST_LIO expects LiDAR-to-IMU extrinsics, and our fused cloud is
      # in base_link frame, we need to express the transformation from base_link
      # to the IMU frame.
      #
      # From multiple_netconfigs.json:
      # - L1 (192.168.1.10): position=[0, 110, 0]mm, rotation=[90°, 0°, 180°]
      # - L2 (192.168.1.18): position=[0, -110, 0]mm, rotation=[90°, 0°, 0°]
      # - IMU is in L1, with internal offset from optical center
      #
      # Computation:
      # 1. L1 optical center in base_link: [0, 0.11, 0] meters
      # 2. L1 rotation (Roll=90°, Yaw=180°) creates transformation matrix R_L1
      # 3. L1 IMU position = L1_optical + R_L1 * [-0.011, -0.02329, 0.04412]
      #    = [0, 0.11, 0] + [0.011, 0.04412, -0.02329]
      #    = [0.011, 0.15412, -0.02329] meters
      # 4. Transform from base_link to L1 IMU (inverse):
      #    T_base_to_imu = -R_L1^T * [0.011, 0.15412, -0.02329]
      #    = -[0.011, -0.02329, 0.15412] = [-0.011, 0.02329, -0.15412]
      # ======================================================================

      extrinsic_T: [-0.011, 0.02329, -0.15412]  # [x, y, z] meters
      #   Translation from fused point cloud (base_link) to IMU frame
      #   x = -0.011m:   11mm offset
      #   y =  0.02329m: 23.29mm offset
      #   z = -0.15412m: 154.12mm offset (includes 110mm base separation)

      # Rotation from base_link to IMU frame
      # L1 is rotated 90° roll and 180° yaw relative to base_link
      # R_base_to_imu = R_L1^T (transpose/inverse of L1's rotation)
      extrinsic_R: [-1.00000,  0.00000,  0.00000,
                     0.00000, -1.00000,  0.00000,
                     0.00000,  0.00000,  1.00000]

    # ==========================================================================
    # PUBLISHING OPTIONS
    # ==========================================================================
    publish:
      path_en: true                      # Publish odometry path (/path topic)
      effect_map_en: false               # Disable to reduce computational load
      map_en: true                       # Publish global map (/cloud_registered)
      scan_publish_en: true              # Publish current scan
      dense_publish_en: false            # Disable dense cloud to save bandwidth
      scan_bodyframe_pub_en: true        # Publish scan in body frame

    # ==========================================================================
    # PCD MAP SAVING
    # ==========================================================================
    pcd_save:
      pcd_save_en: true                  # Save final map to PCD file
      pcd_file_name: "mine_sdk_fusion.pcd"  # Output filename
      interval: -1                       # -1: Save all frames at end (single file)
                                         # >0: Save every N frames (multiple files)

###############################################################################
# CONFIGURATION INSTRUCTIONS FOR SDK FUSION
###############################################################################
#
# To use SDK fusion mode, you MUST configure livox_ros_driver2 as follows:
#
# 1. In livox_params.yaml:
#    - Set multi_topic: 0  (NOT 1!)
#    - This enables SDK-level fusion of both LiDAR point clouds
#
# 2. In multiple_netconfigs.json:
#    - Keep the extrinsic_parameter values for both LiDARs
#    - The SDK will use these to transform point clouds to base_link before fusion
#    - Current values (relative to base_link):
#      * L1 (192.168.1.10): [0, 110, 0]mm, Roll=90°, Pitch=0°, Yaw=180°
#      * L2 (192.168.1.18): [0, -110, 0]mm, Roll=90°, Pitch=0°, Yaw=0°
#
# 3. Launch sequence:
#    a) Start livox_ros_driver2 with multi_topic: 0
#       ros2 launch livox_ros_driver2 multiple_lidars.launch.py
#    b) Verify topics:
#       - /livox/lidar (fused point cloud)
#       - /livox/imu (IMU from primary sensor)
#    c) Start FAST_LIO with this config:
#       ros2 launch fast_lio_ros2 fastlio_sdk_fusion.launch.py
#
# 4. Advantages of SDK fusion:
#    - Lower computational load on FAST_LIO (single point cloud input)
#    - Extrinsic calibration handled at driver level
#    - Simpler FAST_LIO configuration
#    - Better for resource-constrained devices (Jetson)
#
# 5. Disadvantages vs FAST_LIO multi-sensor fusion:
#    - No adaptive fusion strategies (Bundle/Async/Adaptive)
#    - Less flexibility in handling sensor asynchrony
#    - Cannot tune fusion parameters in FAST_LIO
#
###############################################################################

###############################################################################
# TUNING GUIDE FOR UNDERGROUND MINES (SDK FUSION MODE)
###############################################################################
#
# FEATURE-SPARSE TUNNELS:
#   - Decrease point_filter_num: 2 → 1 (keep more points)
#   - Decrease filter_size_surf: 0.3 → 0.2 (finer detail)
#   - Increase max_iteration: 4 → 5 (better convergence)
#
# HIGH VIBRATION:
#   - Increase acc_cov: 0.5 → 1.0
#   - Increase gyr_cov: 0.5 → 1.0
#   - Increase max_iteration: 4 → 5
#
# DUSTY CONDITIONS:
#   - Increase blind: 0.3 → 0.5 (ignore dust near sensor)
#   - Reduce det_range: 50 → 30 (dust limits visibility)
#
# COMPUTATIONAL LIMITS (Jetson ORIN Nano):
#   - Increase point_filter_num: 2 → 3 (more downsampling)
#   - Increase filter_size_surf: 0.3 → 0.5
#   - Increase filter_size_map: 0.4 → 0.5
#   - Reduce cube_side_length: 200 → 100
#
###############################################################################